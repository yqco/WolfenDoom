#include "zcommon.acs"

script "INTRO" OPEN
{
	//Some cinematic intro here is definitely needed!
	delay(1*35);
	ACS_NamedExecuteAlways("BoADialogue",0,"MS_DARR1","MS_DARR0","DARRENMESSAGE47");
}

script "NoTargetDeactivate" ENTER
{
	SetPlayerProperty(1, PROP_NOTARGET, 0);
}

script 1 (void) //Volcano Script
{
    Radius_Quake2(54, 1, 9*35, 0, 8*128, "misc/earthquake");
    //Radius_Quake(1, 70, 0, 128, 54);
    delay(random(15*35, 45*35));
    restart;
}

script "RemoveNotarget" ENTER
{
	TakeInventory("NullWeapon", 1);
	SetWeapon("Luger9mm");
}

int lavacount;

script 2 (int lavapos) //Double Switch
{
    lavacount++;
    thing_activate(lavapos);

    if(lavacount==2)
    {
        floor_lowerbyvalue(110, 10, 160);
    }
}

int bosskilled;

script 3 (void) //Final Script interlude
{
    if(bosskilled==1)
    {
        thing_move(154, 155, 1);
        thing_move(153, 156, 1);
		thing_remove(187);

        floor_raisebyvalue(151, 20, 128);
        SetLineBlocking(152, BLOCK_EVERYTHING);
        bosskilled=0;

        //Ending Cutscene -->
        delay(3*35);
        ACS_NamedExecuteAlways("BoADialogue",0,"MS_PRIS1","MS_PRIS0","PRISONERMESSAGE07");
        delay(12*35);
        thing_activate(154);
        SetActorState(154, "Missile");
        setmusic("C2M6BMUS");
        delay(10);
        thing_activate(153);
        thing_destroy(153, 0, 0);
        
        delay(25);
        
        thing_deactivate(154);
        
        ACS_NamedExecuteAlways("BoADialogue",0,"MS_PRIS1","MS_PRIS0","PRISONERMESSAGE08");
        
        delay(5*35);
        
        thing_activate(154);        
        Thing_SetGoal(154, 157, 0, 1);
		
		ACS_ExecuteAlways(302,0,0,0,0);

        floor_lowerbyvalue(150, 20, 128);
    }
}


int intSetVolume = 1.0;

Script "SetMusicVolumeFactor" (int intTargetVolume, int intDelay)
{
   intTargetVolume *= 256;

   If (intDelay > 0)
   {
      int intStepSize = (intSetVolume - intTargetVolume) / intDelay;

      For (int i = 0; i <= intDelay; i++)
      {
         SetMusicVolume(intSetVolume - (intStepSize * i));
         Delay(1);
      }
   }

   SetMusicVolume(intTargetVolume);
   intSetVolume = intTargetVolume;
}

script 4 (void) //Boss killed
{
    setmusic("NOMUSIC");
    bosskilled=1;
    delay(2*35);
	ACS_NamedExecuteAlways("BoADialogue",0,"MS_DARR1","MS_DARR0","DARRENMESSAGE46");
	delay(5*35);
	//ACS_ExecuteAlways(301,0,0,0,0);
}

script 5 (void) //Spike Script
{
    thing_activate(172);
    delay(35);
    thing_deactivate(172);
    delay(35);
    thing_activate(173);
    delay(35);
    thing_deactivate(173);
    delay(35);
    restart;
}

int finalgate;

script 6 (void)
{
    finalgate++;
    if(finalgate==2)
    {
        ceiling_raisebyvalue(174, 10, 112);
    }
}

script 7 (void) //Boss Battle AracnorbQueen
{
    ceiling_lowerbyvalue(179, 30, 128);
    delay(3*35);
    SetMusic("D_BOSS");
    Radius_Quake2(180, 1, 3*35, 0, 8*128, "misc/earthquake");
    door_raise(178, 20, 0, 0);
    delay(10*35);
    ceiling_raisebyvalue(179, 30, 128);
}

script 8 (void) //Spawn Sword
{
    spawnspotforced("Firebrand", 182, 0, 0);
    thing_move(207, 182, 1);
    SetMusic("NOMUSIC");
    delay(3*35);
    SetMusic("C2M6TRS");
    ACS_NamedExecuteAlways("BoADialogue",0,"MS_DARR1","MS_DARR0","DARRENMESSAGE27");
    thing_move(181,183,0);
    thing_remove(186);
}

script 9 (void) //Darren sends you a message outside
{
    ACS_NamedExecuteAlways("BoADialogue",0,"MS_DARR1","MS_DARR0","DARRENMESSAGE07");
}

script 10 (void) //Darren briefs you
{
    ACS_NamedExecuteAlways("BoADialogue",0,"MS_DARR1","MS_DARR0","DARRENMESSAGE25");
    setlinespecial(181, 0);
    delay(3*35);
    thing_deactivate(183);
}

script 11 (void) //Final Darren briefing
{
    ACS_NamedExecuteAlways("BoADialogue",0,"MS_DARR1","MS_DARR0","DARRENMESSAGE26");
    delay(3*35);
    thing_deactivate(187);
}

script 12 OPEN //Continuos quake
{
        Radius_Quake2(288, 1, 24*60*60*35, 0, 3*128, "misc/earthquake");
}

script 13 (void) //Battle against the general
{
    door_open(205, 20, 0);
    delay(6*35);
    door_open(50, 20, 0);
}

script 14 (int elevatorpos)
{
    if(elevatorpos==0)
    {
        floor_raisebyvalue(206, 20, 512);
        ceiling_raisebyvalue(206, 20, 512);
    }
    if(elevatorpos==1)
    {
        floor_lowerbyvalue(206, 20, 512);
        ceiling_lowerbyvalue(206, 20, 512);
    }
    elevatorpos++;
    if(elevatorpos==2)
    {
        elevatorpos=0;
    }
}


////////////////////////////////

script 255 (void) //Ending Sequence
{
	SetPlayerProperty(1,1,PROP_FROZEN);
    acs_terminate(192, 0);
	ACS_NamedExecuteAlways("SetMusicVolumeFactor", 0, 128, 35);
	delay(35);
	SetMusicVolume(1.0);
	setmusic("music/D_INTER.ogg");
	SetHudSize(480,320,1);
	// Fade to black
	SetFont("BLACKBG");
	hudmessagebold(s: "a"; HUDMSG_FADEINOUT,14,CR_WHITE,240.0,160.0,2.0,3.0,3.0); //...and back
	delay(3*35);
	// Add the moviehud
	SetFont("MOVIEHUD");
    HudMessage(s: "A"; HUDMSG_FADEINOUT, 2, CR_UNTRANSLATED, 320.0, 240.0, 9999.0, 0.0, 0.0);
	//Hide the regular HUD
	GiveInventory("CutsceneEnabled", 1);
	//Change Camera to the room
	ChangeCamera(174, 1, 0);
	Thing_Activate(174);
	//SetFont("ENDC1");
	//hudmessagebold(s: "a"; HUDMSG_FADEINOUT,13,CR_WHITE,240.0,160.0,999.0,2.0,0.0);
	delay(2*35);
	SetPlayerProperty(1,0,PROP_FROZEN);
	SetHudSize(640,480,1);
	SetFont("SMALLFONT");
	hudmessagebold(l:"EPILOGUEC2"; HUDMSG_TYPEON,11,CR_WHITE,170.1,120.1,3.0,0.072,2.0);
	ambientsound("EPILOGUEC2",128);
	delay(3*35);
	hudmessagebold(s: "Press <use> to skip the sequence"; HUDMSG_FADEINOUT,12,CR_GRAY,320.0,460.0,3.0,1.0,1.0);
	acs_execute(256, 0, 0, 0, 0);

	int buttons;
	while (TRUE)
	{
		buttons = GetPlayerInput(-1,INPUT_BUTTONS);
		if (buttons & BT_USE)
		{
			SetHudSize(480,320,1);
			SetFont("BLACKBG");
			hudmessagebold(s: "a"; HUDMSG_FADEINOUT,10,CR_WHITE,240.0,160.0,999.0,2.0,0.0);
			delay(2*35);
			//Hide the regular HUD
			TakeInventory("CutsceneEnabled", 1);
			exit_normal(0);
		}
		delay(1);
	}
}

//////////////////////////////////////
////// Generic Effect Scripts ////////
//////////////////////////////////////

script 402 ENTER { //Setup the player & Map

        //Plane Reflection
        Sector_SetPlaneReflection(61, 32, 0);
        Sector_SetFriction(61, 1.5);
}

script 403 OPEN { //Spark Spawner (id 42)
	thing_activate(138);
	delay(random(10,20));
	thing_deactivate(138);
	delay(random(35,350));
	restart;
}

script 404 (int vent_id) { //Generic vent breaker script
	SetLineBlocking(vent_id,BLOCK_NOTHING);
}

script 405 (int toilet_id) { //Generic Flush Sound WC
	PlaySound(toilet_id,"toilet/flush",CHAN_BODY,1.0,0,0);
}


script 406 (int line_id) { //Generic Mirror Script
	TranslucentLine(line_id,255);
	GlassBreak(0);
	SetLineTexture(line_id,SIDE_FRONT,TEXTURE_MIDDLE,"MIRR_W04");
}

script 407 OPEN { //Water Waggle & Plane Reflection
	//Ceiling_Waggle(30,32,16,0,0);
	Sector_SetPlaneReflection(128,20,0);
}

script 408 (int light_tid) { //Generic Light Script
	if(!GetActorProperty(light_tid,APROP_Dormant))
		Thing_Deactivate(light_tid);
	else
		Thing_Activate(light_tid);
	PlaySound(0,"SW_LIGHT");
}

script 409 (void) { //Generic Ladder Script
    ThrustThingZ(0, 15, 0, 0);
    ACS_NamedExecute("Laddersound", 0, 0, 0, 0);
}

script "Laddersound" (void)
{
    PlaySound (0, "world/ladder", CHAN_BODY, 0.71);
    delay(15);
}

Script 501 (int supplychestid)	//Supply Chest Script
{
	ACS_NamedExecuteAlways("SupplyChest",0,supplychestid,6);//Grenades
}

Script 502 (int supplychestid)	//Supply Chest Script 2
{
	ACS_NamedExecuteAlways("SupplyChest",0,supplychestid,1);//100 Coins
}

////////////////
// OBJECTIVES //
////////////////


script "OBJECTIVES" OPEN
{
	//Set primary objectives
	ACS_NamedExecuteAlways("boaobjectivesset",0,0,0,"MO_ICON_OPN");
	ACS_NamedExecuteAlways("boaobjectivesset",0,1,0,"MO_C2M6C_P1");
	//Set secondary objectives
	ACS_NamedExecuteAlways("boaobjectivesset",0,1,3,"MO_C2M6C_S1");
	ACS_NamedExecuteAlways("boaobjectivesset",0,0,3,"MO_ICON_OPN");
}


script 200 (void)
{
	//Prim Objective 1 solved
	ACS_NamedExecuteAlways("boaobjectivesset",0,0,0,"MO_ICON_ACC");	
	ACS_NamedExecuteAlways("boaobjectiveaccomplished",0,0,0,0);
}

script 201 (void)
{
	//Prim Objective 1 solved
	ACS_NamedExecuteAlways("boaobjectivesset",0,0,1,"MO_ICON_ACC");	
	ACS_NamedExecuteAlways("boaobjectiveaccomplished",0,0,0,0);
}

script 202 (void)
{
	//Prim Objective 1 solved
	ACS_NamedExecuteAlways("boaobjectivesset",0,0,2,"MO_ICON_ACC");	
	ACS_NamedExecuteAlways("boaobjectiveaccomplished",0,0,0,0);
}

script 203 (void)
{
	//Prim Objective 1 solved
	ACS_NamedExecuteAlways("boaobjectivesset",0,0,3,"MO_ICON_ACC");	
	ACS_NamedExecuteAlways("boaobjectiveaccomplished",0,0,0,0);
}


script 301 (void)
{
	//Darren sees dead people
	ACS_NamedExecuteAlways("BoADialogue",0,"MS_DARR1","MS_DARR0","DARRENMESSAGE45");
	delay(5*35);
	
	//Prim Objective 2 added
	ACS_NamedExecuteAlways("boaobjectivesset",0,0,1,"MO_ICON_OPN");
	ACS_NamedExecuteAlways("boaobjectivesset",0,1,1,"MO_C2M6C_P2");
	ACS_NamedExecuteAlways("boaobjectiveadded",0,0,0,0);
}

script 302 (void)
{
	//Prim Objective 3 added
	ACS_NamedExecuteAlways("boaobjectivesset",0,0,2,"MO_ICON_OPN");
	ACS_NamedExecuteAlways("boaobjectivesset",0,1,2,"MO_C2M6C_P3");
	ACS_NamedExecuteAlways("boaobjectiveadded",0,0,0,0);
}
