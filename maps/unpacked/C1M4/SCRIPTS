#include "zcommon.acs"

//Bunch of variables
int down1,down2,down3=1,down4=1,flakvierling=6;

script "OBJECTIVES" OPEN
{
	//Set primary objectives
	ACS_NamedExecuteAlways("boaobjectivesset",0,0,0,"MO_ICON_OPN");
	ACS_NamedExecuteAlways("boaobjectivesset",0,1,0,"MO_C1M4_P1");
	ACS_NamedExecuteAlways("boaobjectivesset",0,0,1,"MO_ICON_OPN");
	ACS_NamedExecuteAlways("boaobjectivesset",0,1,1,"MO_C1M4_P2");
	ACS_NamedExecuteAlways("boaobjectivesset",0,0,2,"MO_ICON_OPN");
	ACS_NamedExecuteAlways("boaobjectivesset",0,1,2,"MO_C1M4_P3");
	//Set secondary objectives
	ACS_NamedExecuteAlways("boaobjectivesset",0,1,3,"MO_C1M4_S1");
	ACS_NamedExecuteAlways("boaobjectivesset",0,0,3,"MO_ICON_OPN");
}

script 201 (void)
{
	//Prim Objective 1 solved
	ACS_NamedExecuteAlways("boaobjectivesset",0,0,0,"MO_ICON_ACC");	
	ACS_NamedExecuteAlways("boaobjectiveaccomplished",0,0,0,0);
}

script 202 (void)
{
	//Prim Objective 3 solved
	ACS_NamedExecuteAlways("boaobjectivesset",0,0,2,"MO_ICON_ACC");	
	ACS_NamedExecuteAlways("boaobjectiveaccomplished",0,0,0,0);
	SetLineSpecial(114, 0, 0, 0, 0, 0, 0);
}

script 203 (void)
{
	//Sec Objective 1 solved
	ACS_NamedExecuteAlways("boaobjectivesset",0,0,3,"MO_ICON_ACC");	
	ACS_NamedExecuteAlways("boaobjectiveaccomplished",0,0,0,0);
}

//Generic vent breaker script
script 404 (int vent_id)
{
	SetLineBlocking(vent_id,BLOCK_NOTHING);
}

script 100 ENTER
{
	GiveInventory("KnifeSilent",1);
	GiveInventory("Luger9mm",1);
	GiveInventory("Sten",1);
	SetWeapon("Sten");
 GiveInventory("C4", 6);
delay(1);
thing_deactivate(106); //we need this in order to deactivate exmark for the final checkpoint - ozy
terminate;
}

Script 1 (void)
{
	SetLineActivation(91, SPAC_None);
	SetLineActivation(112, SPAC_None);
	
	if(!down1)
	{
		Floor_lowerByvalue(60,32,1472);
		Floor_lowerByvalue(90,32,1472);
		FloorAndCeiling_lowerByvalue(61,32,1472);
		FloorAndCeiling_lowerByvalue(95,32,1472);
		//SetLineSpecial(89,103,255,4);
		//SetLineSpecial(91,103,255,4);
		Delay(35*3);
		TeleportInSector(60,63,64,0,0);
		down1++;
		TagWait(60);
		TagWait(61);
		//SetLineSpecial(89,0);
		//SetLineSpecial(91,80,1);
		}
		
		SetLineActivation(112, SPAC_Use);
		SetLineActivation(91, SPAC_Use);
}

Script 2 (void)
{
	
	SetLineActivation(91, SPAC_None);
	SetLineActivation(112, SPAC_None);
	
	if(down1)
	{
		Floor_RaiseByvalue(60,32,1472);
		Floor_RaiseByvalue(90,32,1472);
		FloorAndCeiling_RaiseByvalue(61,32,1472);
		FloorAndCeiling_RaiseByvalue(95,32,1472);
		Delay(35*3);
		//SetLineSpecial(89,102,128,4);
		//SetLineSpecial(91,102,128,4);
		TeleportInSector(61,64,63,0,0);
		down1--;
		TagWait(60);
		TagWait(61);
		//SetLineSpecial(89,0);
		//SetLineSpecial(91,80,1);
	}
	
	SetLineActivation(112, SPAC_Use);
	SetLineActivation(91, SPAC_Use);
}

Script 3 (void)
{
	if(!down2)
	{
		Floor_lowerByvalue(65,32,640);
		down2++;
		TagWait(65);
	}
}

Script 4 (void)
{
	if(down2)
	{
		Floor_RaiseByvalue(65,32,640);
		down2--;
		TagWait(65);
	}
}

Script 5 (void)
{
	SetLineActivation(113, SPAC_None);
	
	if(!down3)
	{
		FloorAndCeiling_LowerByValue(62,32,1152);
		Floor_lowerByvalue(96,32,1152);
		Floor_lowerByvalue(97,32,1152);
		Delay(35*3);
		TeleportInSector(96,68,69,0,0);
		down3++;
		TagWait(19);
		TagWait(62);
	}
	SetLineActivation(113, SPAC_Use);
}

Script 6 (void)
{
	SetLineActivation(113, SPAC_None);
	
	if(down3)
	{
		FloorAndCeiling_RaiseByValue(62,32,1152);
		Floor_RaiseByvalue(96,32,1152);
		Floor_RaiseByvalue(97,32,1152);
		Delay(35*3);
		TeleportInSector(62,69,68,0,0);
		down3--;
		TagWait(96);
		TagWait(62);
		Delay(35*4);
		ACS_ExecuteAlways(5,0,0,0,0);
	}
	SetLineActivation(113, SPAC_Use);
}

Script 7 (void)
{
	if(!down4)
	{
		Floor_lowerByvalue(70,32,256);
		down4++;
		TagWait(70);
	}
}

Script 8 (void)
{
	if(down4)
	{
		Floor_RaiseByvalue(70,32,256);
		down4--;
		TagWait(70);
	}
}

Script 9 (void)
{
	SpawnSpotFacing("WMP40Guard",72,0);
	SpawnSpotFacing("WRifleGuard",74,0);
	SpawnSpotFacing("MGTurretSoldierW",75,0);
	SpawnSpotFacing("WSniper",73,0);
}

Script 10 (void)
{
	SpawnSpotFacing("WMP40Guard",76,0);
}

int message_finished;

//Copy pasted script from C1M3 - modified a bit by Ozy81
script 11 (int artillery_id,int bomblight_id)
{ 
 TakeInventory("C4", 1);
	ThingSound(artillery_id,"DSDETOP",127);
	thing_activate(bomblight_id);
	for(int i=5;i>0;i--)
	{
		ThingSound(artillery_id,"DSDETON",127);
		delay(35);
	}
	//SpawnSpotForced("GeneralExplosion_Large",artillery_id,0,0);
	//SpawnSpotForced("JunkPile1",artillery_id,0,0);
	ThingSound(artillery_id,"panzer/explode",66);
	thing_deactivate(artillery_id); //add this in order to turn the flak inactive, so destroyed
	thing_remove(bomblight_id);
	flakvierling--;
	if(!flakvierling)
	{
		//Prim Objective 2 solved
		ACS_NamedExecuteAlways("boaobjectivesset",0,0,1,"MO_ICON_ACC");	
		ACS_NamedExecuteAlways("boaobjectiveaccomplished",0,0,0,0);
		
		//Line Action
		SetLineSpecial(114, 80, 202, 0, 0, 0, 0);
		
		delay(3*35);
		ACS_NamedExecuteAlways("BoADialogue",0,"MS_PRIS1","MS_PRIS0","PRISONERMESSAGE04");
		delay(5*35);
		Thing_Move(118,98,1);
		
	
   Thing_activate(106);
   Thing_Move(107, 106, 1);
   Thing_Move(108, 109, 1);
		SetLineSpecial(99,74,99,0,0,0,0);
	}
	else if(flakvierling==1)
	{
		Polyobj_DoorSwing(8,16,64,105);
		Delay(70);
		Polyobj_Stop(8);
		delay(5*35);
		message_finished=1;
	}
}

script 12 (void) //Message from Ryan
{
    ACS_NamedExecuteAlways("BoADialogue",0,"MS_PRIS1","MS_PRIS0","PRISONERMESSAGE05");
}

script 13 OPEN //Message from Ryan at the start
{
    ACS_NamedExecuteAlways("BoADialogue",0,"MS_PRIS1","MS_PRIS0","PRISONERMESSAGE06");
}

script 14 (void) //Message from Ryan at the bridge
{
    ACS_NamedExecuteAlways("BoADialogue",0,"MS_PRIS1","MS_PRIS0","PRISONERMESSAGE11");
}

//Generic Light Script
script 408 (int light_tid)
{
	if(!GetActorProperty(light_tid,APROP_Dormant))
		Thing_Deactivate(light_tid);
	else
		Thing_Activate(light_tid);
	PlaySound(0,"SW_LIGHT");
}